rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -----------------------------
    // Helpers
    // -----------------------------
    function isAuth() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    function isOwner(userId) { return isAuth() && uid() == userId; }

    // Permite que SOLO cambien ciertos campos (útil para "markRead" y counters)
    function onlyChanges(allowedKeys) {
      return request.resource.data.diff(resource.data).changedKeys().hasOnly(allowedKeys);
    }

    function isNonNegativeIntField(field) {
      return !(field in request.resource.data)
        || (request.resource.data[field] is int && request.resource.data[field] >= 0);
    }

    // -----------------------------
    // PUBLIC PROFILES (lectura pública)
    // -----------------------------
    match /publicProfiles/{userId} {
      allow read: if true;

      // El dueño puede crear/actualizar su perfil público
      allow create, update: if isOwner(userId);

      // (Opcional) impedir delete desde cliente
      allow delete: if false;
    }

    // -----------------------------
    // USERS (privado)
    // -----------------------------
    match /users/{userId} {
      allow read, create, update, delete: if isOwner(userId);
    }

    // -----------------------------
    // QUESTIONS (lectura pública)
    // -----------------------------
    match /questions/{questionId} {
      allow read: if true;

      // Crear pregunta: usuario autenticado y authorId = uid
      allow create: if isAuth()
        && request.resource.data.authorId == uid();

      // Update:
      // - autor puede editar todo
      // - otros NO (para evitar abusos)
      //
      // Si necesitas que otros incrementen "viewsCount",
      // hazlo vía Cloud Function o cambia a la alternativa de abajo.
      allow update: if isAuth() && resource.data.authorId == uid();

      allow delete: if isAuth() && resource.data.authorId == uid();

      // -----------------------------
      // ANSWERS (subcolección)
      // -----------------------------
      match /answers/{answerId} {
        allow read: if true;

        allow create: if isAuth()
          && request.resource.data.authorId == uid();

        allow update, delete: if isAuth() && resource.data.authorId == uid();

        // -----------------------------
        // RATINGS (subcolección)
        // -----------------------------
        match /ratings/{ratingId} {
          allow read: if true;

          // Cada usuario crea su rating (userId = uid)
          allow create: if isAuth()
            && request.resource.data.userId == uid();

          // Update/Delete solo del dueño del rating
          allow update, delete: if isAuth() && resource.data.userId == uid();
        }
      }
    }

    // -----------------------------
    // NOTIFICATIONS (privado por usuario)
    // -----------------------------
    match /notifications/{userId}/items/{notificationId} {
      // Solo el dueño puede leer
      allow read: if isOwner(userId);

      // Crear:
      // - recomendado que lo haga Cloud Function
      // - pero si lo haces desde cliente:
      //   permite crear SOLO si "toUserId" coincide con el path userId
      allow create: if isAuth()
        && request.resource.data.toUserId == userId;

      // Marcar como leída (update limitado)
      allow update: if isOwner(userId)
        && onlyChanges(["read", "readAt", "updatedAt"]);

      // Delete opcional (si quieres permitir limpiar notifs)
      allow delete: if isOwner(userId);
    }

    // -----------------------------
    // DEFAULT: niega todo lo no contemplado
    // -----------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
